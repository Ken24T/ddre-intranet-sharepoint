openapi: 3.0.3
info:
  title: DDRE Intranet Vault API Proxy
  version: 0.1.0
  description: |
    Secure proxy for Vault (Sales CRM) API.
    
    This proxy:
    - Provides full CRUD access to Vault CRM data
    - Handles authentication with Vault API
    - Enforces user permissions based on SharePoint groups
    
    **Security:** API keys are stored in Azure Key Vault. SPFx never sees credentials.
    
    **Consumer:** Sales area apps (1 or more SPFx solutions)
    
    **Capabilities:** Full CRUD

servers:
  - url: https://api-dev.dougdisher.com.au
    description: Development
  - url: https://api-test.dougdisher.com.au
    description: Test
  - url: https://api.dougdisher.com.au
    description: Production

paths:
  /api/v1/vault/health:
    get:
      operationId: getHealth
      summary: Health check
      tags: [System]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # =========================================================================
  # CONTACTS
  # =========================================================================
  /api/v1/vault/contacts:
    get:
      operationId: listContacts
      summary: List contacts
      tags: [Contacts]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageNumber'
        - $ref: '#/components/parameters/PageSize'
        - name: search
          in: query
          schema:
            type: string
          description: Search by name or email
      responses:
        '200':
          description: List of contacts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactListResponse'
        '401':
          description: Unauthorized

    post:
      operationId: createContact
      summary: Create a new contact
      tags: [Contacts]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactCreateRequest'
      responses:
        '201':
          description: Contact created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '400':
          description: Validation error
        '401':
          description: Unauthorized

  /api/v1/vault/contacts/{id}:
    get:
      operationId: getContact
      summary: Get a contact by ID
      tags: [Contacts]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '200':
          description: Contact details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '404':
          description: Contact not found

    put:
      operationId: updateContact
      summary: Update a contact
      tags: [Contacts]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactUpdateRequest'
      responses:
        '200':
          description: Contact updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '404':
          description: Contact not found

    delete:
      operationId: deleteContact
      summary: Delete a contact
      tags: [Contacts]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '204':
          description: Contact deleted
        '404':
          description: Contact not found

  # =========================================================================
  # DEALS / OPPORTUNITIES (placeholder - expand as needed)
  # =========================================================================
  /api/v1/vault/deals:
    get:
      operationId: listDeals
      summary: List deals/opportunities
      tags: [Deals]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageNumber'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: List of deals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DealListResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: SharePoint access token passed through from SPFx

  parameters:
    ResourceId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Resource ID

    PageNumber:
      name: page
      in: query
      schema:
        type: integer
        default: 1
        minimum: 1
      description: Page number

    PageSize:
      name: pageSize
      in: query
      schema:
        type: integer
        default: 20
        minimum: 1
        maximum: 100
      description: Items per page

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        pageSize:
          type: integer
        totalItems:
          type: integer
        totalPages:
          type: integer

    Contact:
      type: object
      properties:
        id:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        company:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ContactCreateRequest:
      type: object
      required:
        - firstName
        - lastName
      properties:
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        company:
          type: string

    ContactUpdateRequest:
      type: object
      properties:
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        company:
          type: string

    ContactListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Contact'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    Deal:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        value:
          type: number
          format: float
        stage:
          type: string
        contactId:
          type: string
        createdAt:
          type: string
          format: date-time

    DealListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Deal'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
